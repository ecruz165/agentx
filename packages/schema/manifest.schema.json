{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://agentx.dev/schemas/manifest.schema.json",
  "title": "AgentX Manifest",
  "description": "Unified manifest schema for all AgentX composable types. Each type is discriminated by the 'type' field.",
  "oneOf": [
    { "$ref": "#/$defs/contextManifest" },
    { "$ref": "#/$defs/personaManifest" },
    { "$ref": "#/$defs/skillManifest" },
    { "$ref": "#/$defs/workflowManifest" },
    { "$ref": "#/$defs/promptManifest" },
    { "$ref": "#/$defs/templateManifest" }
  ],
  "$defs": {
    "baseManifest": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9][a-z0-9-]*$",
          "description": "Unique identifier for this type. Lowercase alphanumeric with hyphens."
        },
        "type": {
          "type": "string",
          "enum": ["context", "persona", "skill", "workflow", "prompt", "template"],
          "description": "The composable type discriminator."
        },
        "version": {
          "type": "string",
          "pattern": "^v?[0-9]+(\\.[0-9]+)*(-[a-zA-Z0-9.-]+)?$",
          "description": "Version string. Relaxed semver: accepts 1.0, 1.2.3, v1.2.3, 1.2.3-beta.1."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable description of what this type provides."
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Tags for discovery and categorization."
        },
        "author": {
          "type": "string",
          "description": "Author or maintainer name."
        },
        "vendor": {
          "type": ["string", "null"],
          "description": "Vendor or ecosystem (e.g., aws, github, splunk). Null if not vendor-specific."
        }
      },
      "required": ["name", "type", "version", "description"]
    },

    "contextManifest": {
      "allOf": [
        { "$ref": "#/$defs/baseManifest" },
        {
          "type": "object",
          "properties": {
            "type": { "const": "context" },
            "format": {
              "type": "string",
              "description": "Content format of context files (e.g., markdown, text)."
            },
            "tokens": {
              "type": "integer",
              "minimum": 0,
              "description": "Approximate token count for AI consumption budgeting."
            },
            "sources": {
              "type": "array",
              "items": { "type": "string" },
              "minItems": 1,
              "description": "List of source files that comprise this context."
            }
          },
          "required": ["type", "format", "sources"]
        }
      ]
    },

    "personaManifest": {
      "allOf": [
        { "$ref": "#/$defs/baseManifest" },
        {
          "type": "object",
          "properties": {
            "type": { "const": "persona" },
            "expertise": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Areas of expertise for this persona."
            },
            "tone": {
              "type": "string",
              "description": "Communication style (e.g., direct, pragmatic, opinionated)."
            },
            "conventions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Coding conventions and preferences this persona enforces."
            },
            "context": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^context/[a-z0-9-]+(/[a-z0-9-]+)*$"
              },
              "description": "References to context types this persona uses."
            },
            "template": {
              "type": "string",
              "description": "Path to the persona instruction template file (e.g., persona.md)."
            }
          },
          "required": ["type"]
        }
      ]
    },

    "skillManifest": {
      "allOf": [
        { "$ref": "#/$defs/baseManifest" },
        {
          "type": "object",
          "properties": {
            "type": { "const": "skill" },
            "runtime": {
              "type": "string",
              "enum": ["node", "go"],
              "description": "Execution runtime for this skill."
            },
            "topic": {
              "type": "string",
              "description": "Topic category (e.g., scm, cloud, cicd, observability)."
            },
            "cli_dependencies": {
              "type": "array",
              "items": { "$ref": "#/$defs/cliDependency" },
              "description": "External CLI tools this skill requires."
            },
            "inputs": {
              "type": "array",
              "items": { "$ref": "#/$defs/inputField" },
              "description": "Input parameters for this skill."
            },
            "outputs": {
              "$ref": "#/$defs/outputDeclaration",
              "description": "Output format declaration."
            },
            "registry": {
              "$ref": "#/$defs/registryBlock",
              "description": "Registry declaration for userdata folder structure."
            }
          },
          "required": ["type", "runtime", "topic"]
        }
      ]
    },

    "workflowManifest": {
      "allOf": [
        { "$ref": "#/$defs/baseManifest" },
        {
          "type": "object",
          "properties": {
            "type": { "const": "workflow" },
            "runtime": {
              "type": "string",
              "enum": ["node", "go"],
              "description": "Execution runtime for this workflow."
            },
            "steps": {
              "type": "array",
              "items": { "$ref": "#/$defs/workflowStep" },
              "minItems": 1,
              "description": "Ordered list of skill invocations."
            },
            "inputs": {
              "type": "array",
              "items": { "$ref": "#/$defs/inputField" },
              "description": "Input parameters for this workflow."
            },
            "outputs": {
              "$ref": "#/$defs/outputDeclaration",
              "description": "Output format declaration."
            }
          },
          "required": ["type", "runtime", "steps"]
        }
      ]
    },

    "promptManifest": {
      "allOf": [
        { "$ref": "#/$defs/baseManifest" },
        {
          "type": "object",
          "properties": {
            "type": { "const": "prompt" },
            "persona": {
              "type": "string",
              "pattern": "^personas/[a-z0-9-]+$",
              "description": "Reference to a persona type."
            },
            "context": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^context/[a-z0-9-]+(/[a-z0-9-]+)*$"
              },
              "description": "References to context types."
            },
            "skills": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^skills/[a-z0-9-]+(/[a-z0-9-]+)*$"
              },
              "description": "References to skill types."
            },
            "workflows": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^workflows/[a-z0-9-]+(/[a-z0-9-]+)*$"
              },
              "description": "References to workflow types."
            },
            "template": {
              "type": "string",
              "description": "Path to the prompt template file (e.g., prompt.hbs)."
            }
          },
          "required": ["type"]
        }
      ]
    },

    "templateManifest": {
      "allOf": [
        { "$ref": "#/$defs/baseManifest" },
        {
          "type": "object",
          "properties": {
            "type": { "const": "template" },
            "format": {
              "type": "string",
              "description": "File extension / format of the template (e.g., spl, hbs, md)."
            },
            "variables": {
              "type": "array",
              "items": { "$ref": "#/$defs/templateVariable" },
              "description": "Variables available for substitution in this template."
            }
          },
          "required": ["type", "format"]
        }
      ]
    },

    "cliDependency": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "CLI tool name (e.g., git, aws, kubectl)."
        },
        "min_version": {
          "type": "string",
          "description": "Minimum required version."
        }
      },
      "required": ["name"],
      "additionalProperties": false
    },

    "inputField": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Parameter name."
        },
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean", "array", "object"],
          "description": "Parameter data type."
        },
        "required": {
          "type": "boolean",
          "description": "Whether this input is required."
        },
        "default": {
          "description": "Default value if not provided."
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of this input."
        }
      },
      "required": ["name", "type"],
      "additionalProperties": false
    },

    "outputDeclaration": {
      "type": "object",
      "properties": {
        "format": {
          "type": "string",
          "description": "Output format (e.g., json, text)."
        },
        "schema": {
          "type": "string",
          "description": "Path to JSON Schema file for output validation."
        }
      },
      "required": ["format"],
      "additionalProperties": false
    },

    "registryBlock": {
      "type": "object",
      "properties": {
        "tokens": {
          "type": "array",
          "items": { "$ref": "#/$defs/registryToken" },
          "description": "Environment variables / secrets required by this skill."
        },
        "config": {
          "type": "object",
          "description": "Default configuration values written to config.yaml on first run.",
          "additionalProperties": true
        },
        "state": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files this skill may create in the state/ directory."
        },
        "output": {
          "type": "object",
          "properties": {
            "schema": {
              "type": "string",
              "description": "Path to JSON Schema for output/latest.json validation."
            }
          },
          "additionalProperties": false
        },
        "templates": {
          "oneOf": [
            { "type": "null" },
            {
              "type": "object",
              "properties": {
                "format": {
                  "type": "string",
                  "description": "File extension for saved templates."
                },
                "description": {
                  "type": "string",
                  "description": "Description of what graduated templates contain."
                }
              },
              "required": ["format"],
              "additionalProperties": false
            }
          ],
          "description": "Template graduation configuration. Null if skill doesn't produce templates."
        }
      },
      "additionalProperties": true
    },

    "registryToken": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Environment variable name."
        },
        "required": {
          "type": "boolean",
          "description": "Whether this token must be set before the skill can run."
        },
        "default": {
          "type": "string",
          "description": "Default value if not set."
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of this token."
        }
      },
      "required": ["name"],
      "additionalProperties": false
    },

    "workflowStep": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique step identifier within this workflow."
        },
        "skill": {
          "type": "string",
          "pattern": "^skills/[a-z0-9-]+(/[a-z0-9-]+)*$",
          "description": "Reference to the skill to invoke."
        },
        "inputs": {
          "type": "object",
          "additionalProperties": true,
          "description": "Input mappings for this step. Supports ${inputs.*} and ${steps.*} interpolation."
        }
      },
      "required": ["id", "skill"],
      "additionalProperties": false
    },

    "templateVariable": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Variable name for substitution."
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of this variable."
        },
        "default": {
          "type": "string",
          "description": "Default value if not provided."
        },
        "required": {
          "type": "boolean",
          "description": "Whether this variable must be provided."
        }
      },
      "required": ["name"],
      "additionalProperties": false
    }
  }
}
